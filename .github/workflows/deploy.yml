name: Deploy to Server

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: Test server connectivity
      timeout-minutes: 2
      continue-on-error: true
      run: |
        echo "üîç Testando conectividade com o servidor..."
        echo "IP do servidor: ${{ secrets.SERVER_HOST }}"
        
        # Testar ping (pode falhar se ICMP estiver bloqueado, mas n√£o √© cr√≠tico)
        if ping -c 2 -W 5 ${{ secrets.SERVER_HOST }} 2>/dev/null; then
          echo "‚úÖ Ping respondeu"
        else
          echo "‚ö†Ô∏è Ping n√£o respondeu (pode ser normal se ICMP estiver bloqueado)"
        fi
        
        # Testar porta 22 com timeout e retry
        echo "üîå Testando porta SSH (22)..."
        PORT_ACCESSIBLE=false
        for i in {1..3}; do
          if timeout 5 bash -c "echo > /dev/tcp/${{ secrets.SERVER_HOST }}/22" 2>/dev/null; then
            echo "‚úÖ Porta 22 est√° acess√≠vel (tentativa $i/3)"
            PORT_ACCESSIBLE=true
            break
          else
            echo "‚ö†Ô∏è Tentativa $i/3: Porta 22 n√£o acess√≠vel (pode ser firewall tempor√°rio)"
            if [ $i -lt 3 ]; then
              sleep 2
            fi
          fi
        done
        
        if [ "$PORT_ACCESSIBLE" = "false" ]; then
          echo "‚ö†Ô∏è Porta 22 n√£o est√° acess√≠vel (testando continuar√° com SSH direto)"
          echo "Poss√≠veis causas:"
          echo "  - Firewall bloqueando conex√µes do GitHub Actions (mas pode permitir SSH)"
          echo "  - Porta SSH pode estar em outra porta (2222, 22022, etc)"
          echo "  - Servidor pode estar em manuten√ß√£o"
          echo ""
          echo "‚ÑπÔ∏è Continuando com teste SSH direto (pode funcionar mesmo se teste de porta falhar)"
        fi
    
    - name: Test SSH connection
      timeout-minutes: 2
      run: |
        echo "üîë Testando conex√£o SSH..."
        ssh -o StrictHostKeyChecking=no \
            -o ConnectTimeout=20 \
            -o ServerAliveInterval=30 \
            -o ServerAliveCountMax=3 \
            -o BatchMode=yes \
            -v root@${{ secrets.SERVER_HOST }} 'echo "‚úÖ Conex√£o SSH OK"' || {
          echo "‚ùå Falha ao conectar via SSH"
          echo "Verifique:"
          echo "  1. Se a chave SSH est√° configurada corretamente no GitHub Secrets"
          echo "  2. Se o servidor est√° acess√≠vel (IP: ${{ secrets.SERVER_HOST }})"
          echo "  3. Se o firewall permite conex√µes do GitHub Actions"
          exit 1
        }
    
    - name: Deploy to server (Docker / Traefik)
      timeout-minutes: 10
      run: |
        echo "üöÄ Iniciando deploy..."
        ssh -o StrictHostKeyChecking=no \
            -o ConnectTimeout=20 \
            -o ServerAliveInterval=30 \
            -o ServerAliveCountMax=3 \
            -o BatchMode=yes \
            root@${{ secrets.SERVER_HOST }} '
          set -e
          cd /root/phdstudio || exit 1
          chmod +x deploy/docker/scripts/deploy-remote.sh || exit 1
          ./deploy/docker/scripts/deploy-remote.sh || exit 1
        '
    
    - name: Notify deployment
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "‚úÖ Deploy conclu√≠do com sucesso!"
        else
          echo "‚ùå Deploy falhou!"
          echo ""
          echo "Troubleshooting:"
          echo "1. Verifique se o servidor est√° online: ping ${{ secrets.SERVER_HOST }}"
          echo "2. Verifique se a porta 22 est√° aberta: telnet ${{ secrets.SERVER_HOST }} 22"
          echo "3. Verifique se a chave SSH est√° correta no GitHub Secrets"
          echo "4. Verifique logs do servidor: journalctl -u sshd -n 50"
        fi

